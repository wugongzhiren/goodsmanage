<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/css/ui.jqgrid.css"/>
    <link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css"/>
    <script src="/js/jquery-3.1.1.min.js"></script>
    <!-- 包括所有已编译的插件 -->
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/grid.locale-cn.js"></script>
    <script src="/js/grid.jqueryui.js"></script>
    <script src="/js/jquery.jqGrid.min.js"></script>

</head>
<body>
商品名<input id="goodsName" type="text"/>
商品分类<input id="goodsType" type="text"/>
型号<input id="goodsVersion" type="text"/>
定价<input id="price" type="text"/>
数量<input id="goodsCount" type="text"/>
<button onclick="instore()">
    入库，生成条码并打印
</button>

如果商品之前已经入库过，请查询后填入对应商品的入库数量
<input id="goodsNameinput" type="text" placeholder="输入商品名查询商品信息,支持模糊搜索"/>
<button onclick="reload()">查询</button>
<button onclick="save()">保存</button>
<table id="goodsList"></table>
<div id="pager"></div>
<script>
    /**
     * 商品入库操作
     */
    function instore() {
        var goodsName = $("#goodsName").val();
        var goodsType = $("#goodsType").val();
        var goodsVersion = $("#goodsVersion").val();
        var goodsCount = $("#goodsCount").val();
        var price = $("#price").val();
        if (goodsName == "" || goodsVersion == "" || goodsCount == "" || price == "" || goodsType == "") {
            alert('请输入完整的入库信息');
            return;
        }
        //后台通信，保存信息到数据库
        $.ajax({
            url: '/instore',
            type: "post",
            data: {
                goodsName: goodsName,
                goodsType: goodsType,
                goodsVersion: goodsVersion,
                goodsCount: goodsCount,
                price: price
            },
            error: function (error) {
                alert("系统异常，请重新操作")
            },
            success: function (data) {
                alert("操作成功")
            }
        })
    }

    var lastsel=1;
//商品模型配置
    jQuery("#goodsList").jqGrid({
        url: "/getGoodsInfo",
        datatype: "local",
        mtype: 'GET',
        colNames: [ '条形码', '商品名', '商品类别', '型号','单价', '数量','新增入库数量'],
        colModel: [
            {name: 'zxingCode', index: 'zxingCode', width: 100, align: "center"},
            {name: 'goodsName', index: 'goodsName', width: 100, align: "center"},
            {name: 'goodsType', index: 'goodsType', width: 150, align: "center"},
            {name: 'goodsVersion', index: 'goodsVersion', width: 150, align: "center"},
            {name: 'price', index: 'price', width: 150, align: "center"},
            {name: 'goodsCount', index: 'goodsCount', width: 150, align: "center"},
            {name: 'addCount', index: 'addCount', width: 150, align: "center",editable:true,editrules:{edithidden:true,required:false,number:true,minValue:1}}
        ],
        rownumbers:true,
        multiselect: true,
        multiboxonly:true,
        cellEdit:true,
        loadComplete: function () {
            var rowIds = $("#goodsList").jqGrid('getDataIDs');
            var curRowData = $("#goodsList").jqGrid('getRowData', rowIds[0]);
            if(curRowData.zxingCode=="") {
                alert("未查询到数据");
            }
        },
        beforeSelectRow:function beforeSelectRow()
        {
            $("#goodsList").jqGrid('resetSelection');
            return(true);
        },
        rowList: [10, 20, 30],
        viewrecords: true,
        loadonce:false,
        sortable: false,
        pager: jQuery('#pager'),
        rowNum: 5,
        altclass: 'altRowsColor',
//width: 'auto',
        width: '1200',
        height: '340',
        caption: "商品信息一览"
    })


    $('html').bind('click', function(e) { //用于点击其他地方保存正在编辑状态下的行
        if ( lastsel != "" ) { //if a row is selected for edit
            if($(e.target).closest('#goodsList').length == 0) { //and the click is outside of the grid //save the row being edited and unselect the row
                jQuery('#goodsList').jqGrid('saveRow', lastsel);
                jQuery('#goodsList').resetSelection();
                lastsel="";
            }
        }
    });


    function reload() {
       var goodsName=$("#goodsNameinput").val();
        $("#goodsList").jqGrid('setGridParam',{
            datatype:'json',
            mtype: 'GET',
            postData:{'goodsName':goodsName} //发送数据
            /*page:1*/
        }).trigger("reloadGrid"); //重新载入
    }

    //保存已经入库过的新增商品数量
    function save() {
        var curRowDataID=$("#goodsList").jqGrid("getGridParam","selrow");
        if(curRowDataID==null){
            alert("请选择一条数据后进行操作");
            return;
        }
        var rowData = $("#goodsList").jqGrid("getRowData",curRowDataID);
        //此次新增数
        var addCount=rowData["addCount"];
//验证为正整数
        var type = /^[0-9]*[1-9][0-9]*$/;
        var re = new RegExp(type);
        //alert(ss.match(re));
        if (addCount.match(re) == null) {
            alert("新增数量必须是大于零的整数!");
            return;
        }
        //对应的条码
        var zxingCode=rowData["zxingCode"];
        $.ajax({
            url: '/addCount',
            type: "get",
            data: {
                zxingCode: zxingCode,
                addCount: addCount
            },
            error: function (error) {
                alert("系统异常，请重新操作")
            },
            success: function (data) {
                if(data=="100") {

                    alert("操作成功");
                    reload();
                }
                else{
                    alert("操作失败，请刷新后重试！");
                }
            }
        })
    }
</script>
</body>

</html>